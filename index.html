<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>Ansible チュートリアル | Ansible Tutorial in Japanese</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ansible Tutorial in Japanese. Setup Wordpress server and check with ServerSpec.">
    <meta name="author" content="@yteraoka">

    <link href='http://fonts.googleapis.com/css?family=Kavoon' rel='stylesheet' type='text/css'>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <link href="css/docs.css" rel="stylesheet">
    <link href="css/pygments-manni.css" rel="stylesheet">

    <style type="text/css">
      .console-input {
        font-weight: bold;
      }
      .console-ok {
        color: limegreen;
        font-weight: bold;
      }
      .console-changed {
        color: darkorange;
        font-weight: bold;
      }
      .console-error {
        color: red;
        font-weight: bold;
      }
      dd {
        margin-bottom: 1em;
      }
      dd pre {
        margin-top: 4px;
      }
    </style>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42721713-1', 'yteraoka.github.io');
  ga('send', 'pageview');

</script>

  </head>
  <body>

    <div class="container">

      <!-- Main component for a primary marketing message or call to action -->
      <div class="jumbotron">
        <h1 style="font-family: Kavoon">Ansible Tutorial</h1>
        <p><a href="http://www.techfesta.jp/">July Tech Festa</a> にて開催されたハンズオンの<a href="http://tily.github.io/jtf2013/">資料が公開</a>されていたことに刺激され、Chef の代わりに Ansible を使う資料を作りました。 Ansible を使って WordPress サーバーのセットアップを行い、ServerSpec でテストを行います。 まだ Ansible を試し始めたばかりで自分の勉強がてら書いています。 Puppet にも Chef にも乗り遅れたので Ansible に飛び乗ってみようかと。</p>
        <p><a class="btn btn-primary btn-lg" href="https://github.com/yteraoka/ansible-tutorial/">GitHub Repository</a>
        <a class="btn btn-info btn-lg" href="https://github.com/yteraoka/ansible-tutorial/wiki/Ansible-Note">Ansible Tutorial Wiki</a></p>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading">History</div>
        <ul class="list-group">
          <li class="list-group-item">2013年08月13日 一段落<br>コピペで動かないところを全体的に修正しました。今後は <del>詳細ページ</del> Wiki を充実させていきます</li>
          <li class="list-group-item">2013年09月09日 <br>role についての追記しました</li>
          <li class="list-group-item">2013年12月22日 リニューアル<br>Ansible 1.4 でテスト済み
        </ul>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading">Ansible とは</div>
        <ul class="list-group">
          <li class="list-group-item">
Ansible のサイト (<a href="http://www.ansibleworks.com/">AnsibleWorks | Radically simple IT orchestration</a>) には次のように書いてあります<br>
<blockquote>
Ansible は非常にシンプルなIT構成エンジンです。これはあなたのアプリケーションやシステムのデプロイを容易にします。スクリプトや専用のコードを書くことなくアプリケーションをデプロイし、更新することができます。エージェントをインストールすることなく、SSH を使い、自然な英語に近い感覚で自動化します。
Ansible は最もシンプルな構成管理、自動化ツールです。
</blockquote>
次のサイトも参考になります
<ul>
  <li><a href="http://apatheia.info/blog/2013/04/06/about-ansible/">構成管理ツール Ansible について - apatheia.info</a></li>
  <li><a href="http://tdoc.info/blog/2013/04/20/ansible.html">ansibleを使ってみる — そこはかとなく書くよん。</a></li>
  <li><a href="https://speakerdeck.com/yeukhon/deploying-with-vagrant-and-ansible">Deploying with Vagrant and Ansible by yeukhon</a> [speakerdeck]</li>
</ul>
(これ、とても良いスライドです。この Tutorial の後にどうぞ..)
          </li>
        </ul>
      </div>

      <div class="page-header">
        <h1>Table of Contents</h1>
      </div>

      <p>
        <ol>
          <li><a href="#server-setup-using-vagrant">Vagrant を使ってサーバーを準備する</a></li>
          <li><a href="#install-ansible">Ansible のインストール</a></li>
          <li><a href="#test-ansible">Ansible の疎通確認</a></li>
          <li><a href="#simple-playbook">簡単な Playbook を書いて試す</a></li>
          <li><a href="#gather-facts">対象ホストの情報を取得 (GATHERING FACTS)</a></li>
          <li><a href="#best-practices">Best Practices に沿った構成を真似る</a>
            <ol>
              <li><a href="#best-practices-directory">各ディレクトリ、ファイルの役割・意味</a>
              <li><a href="#list-variable">リスト型変数を使った処理</a>
              <li><a href="#mysql">MySQL 関連</a>
            </ol>
          </li>
          <li><a href="#test-with-serverspec">serverspec でテストする</a>
            <ol>
              <li><a href="#install-ruby">Ruby のインストール</a>
              <li><a href="#install-serverspec">ServerSpec のインストール</a>
              <li><a href="#execute-serverspec">ServerSpec を実行してみる</a>
              <li><a href="#test-mysqld">mysqld のテストを作成</a>
              <li><a href="#test-wordpress">WordPress のテストを作成</a>
            </ol>
          </li>
          <li><a href="#more">もっと知る</a></li>
        </ol>
      </p>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="server-setup-using-vagrant" class="anchor" href="#server-setup-using-vagrant"></a>1. Vagrant を使ってサーバーを準備する</h1>
      </div>

      <p>何度でも綺麗な環境でやり直せるように VirtualBox + Vagrant を使ってこの Tutorial 用環境を構築します。
        <ul>
          <li><a href="http://blog.1q77.com/2013/03/vagrant-1/">Vagrant メモ(1)</a></li>
          <li><a href="http://blog.1q77.com/2013/03/vagrant-2/">Vagrant メモ(2)</a></li>
        </ul>
        あたりを参考に最新版の VirtualBox と Vagrant をインストールしてください。
      </p>

<div><pre><code>$ <span class="console-input">mkdir ansible-tutorial</span>
$ <span class="console-input">cd ansible-tutorial</span>
$ <span class="console-input">vagrant init centos6 http://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_centos-6.5_chef-provisionerless.box</span>
</code></pre></div>

      <p>Ansible サーバーと、Ansible に制御される側の2台のサーバーを立てることにするので <code>Vagrantfile</code> を編集します
      </p>

<div><pre><code>$ <span class="console-input">vi Vagrantfile</span></code></pre></div>

      <p><code>config.vm.box = "centos6"</code> の行を次のように書き換えます。2台じゃなくて3台でも4台でもOK
      </p>

<div><pre><code>  config.vm.define :node1 do |node|
    node.vm.box = "centos6"
    node.vm.network :forwarded_port, guest: 22, host: 2001, id: "ssh"
    node.vm.network :private_network, ip: "192.168.33.11"
  end

  config.vm.define :node2 do |node|
    node.vm.box = "centos6"
    node.vm.network :forwarded_port, guest: 22, host: 2002, id: "ssh"
    node.vm.network :forwarded_port, guest: 80, host: 8000, id: "http"
    node.vm.network :private_network, ip: "192.168.33.12"
  end</code></pre></div>

      <p>編集が終わったら起動させます</p>

<div><pre><code>$ <span class="console-input">vagrant up</span></code></pre></div>

      <p>起動後、Ansible で node1 から node2 へ ssh するため、Vagrant 用の秘密鍵をコピーする</p>

<div><pre><code>$ <span class="console-input">vagrant ssh-config node1 &gt; ssh_config</span>
$ <span class="console-input">vagrant ssh-config node2 &gt;&gt; ssh_config</span>
$ <span class="console-input">scp -F ssh_config ~/.vagrant.d/insecure_private_key node1:.ssh/id_rsa</span></code></pre></div>

      <p><code>vagrant ssh</code> コマンドでログインできます</p>

<div><pre><code>$ <span class="console-input">vagrant ssh node1</span>
$ <span class="console-input">vagrant ssh node2</span></code></pre></div>

      <p>やり直したくなったら destroy して up すれば元の状態に戻ります</p>

<div><pre><code>$ <span class="console-input">vagrant destroy node2</span>
$ <span class="console-input">vagrant up node2</span></code></pre></div>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="install-ansible" class="anchor" href="#install-ansible"></a>2. Ansible をインストールする</h1>
      </div>

      <p><a href="http://dl.fedoraproject.org/pub/epel/6/x86_64/repoview/ansible.html">EPEL</a> から yum でもインストール可能ですが、ここは pip で最新版をインストールします。CentOS 6 の Python は 2.6 なのでついでに 2.7 の最新を入れます (@tagomoris さんの xbuild を使わせてもらいます)</p>

<div><pre><code>$ <span class="console-input">sudo yum install bzip2-devel sqlite-devel</span>
$ <span class="console-input">cd /var/tmp</span>
$ <span class="console-input">git clone https://github.com/tagomoris/xbuild.git</span>
$ <span class="console-input">sudo xbuild/python-install 2.7.6 /opt/python-2.7</span>
$ <span class="console-input">sudo /opt/python-2.7/bin/pip install ansible</span>
$ <span class="console-input">echo 'PATH=/opt/python-2.7/bin:$PATH' &gt;&gt; ~/.bashrc</span></code></pre></div>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="test-ansible" class="anchor" href="#test-ansible"></a>3. Ansible の疎通確認</h1>
      </div>

      <p>node1 から ping モジュールで疎通確認してみます</p>

<div><pre><code>$ <span class="console-input">vagrant ssh node1</span>

$ <span class="console-input">ansible 192.168.33.12 -m ping</span>
<span class="console-error">ERROR: Unable to find an inventory file, specify one with -i ?</span></code></pre></div>

      <p>おっとエラーです。<code>-i</code> で inventory file を指定せよと言われています。Ansible は<a href="https://github.com/yteraoka/ansible-tutorial/wiki/Inventory-File">インベントリファイル</a>に書かれたホストにしかアクセスしません。デフォルトのインベントリファイルが <code>/etc/ansible/hosts</code> です(<code>ansible.cfg</code>で定義されています)が、コマンドラインオプションの <code>-i</code> で指定できます。</p>

      <p>ちなみに ansible.cfg は次の順で探します
        <ol>
          <li>カレントディレクトリ</li>
          <li>環境変数の ANSIBLE_CONFIG or ~/ansible.cfg</li>
          <li>/etc/ansible/ansible.cfg</li>
        </ol>
      </p>

      <p>ここではとりあえずカレントディレクトリに <code>hosts</code> ファイルを作成しましょう。</p>

<div><pre><code>$ <span class="console-input">echo 192.168.33.12 &gt; hosts</span></code></pre></div>

      <p>今度は <code>-i</code> でインベントリファイルを指定して ping モジュールを実行してみましょう</p>

<div><pre><code>$ <span class="console-input">ansible -i hosts 192.168.33.12 -m ping</span>

paramiko: The authenticity of host '192.168.33.12' can't be established. 
The ssh-rsa key fingerprint is 80c661a0ec2d1f68d5352986ad417f2c. 
Are you sure you want to continue connecting (yes/no)?
<span class="console-input">yes</span>
<span class="console-ok">192.168.33.12 | success &gt;&gt; {
    "changed": false, 
    "ping": "pong"
}</span></code></pre></div>

      <p>ok ですね (たしか、バージョン 1.3 から host key をチェックするようになりました)</p>

      <p>次はリモートホストで任意のコマンドを実行してみましょう</p>

<div><pre><code>$ <span class="console-input">ansible -i hosts 192.168.33.12 -a 'uname -r'</span>
<span class="console-ok">192.168.33.12 | success | rc=0 &gt;&gt;
2.6.32-431.el6.x86_64</span></code></pre></div>

      <p>ついでに yum モジュールでパッケージのインストールも試してみましょう</p>

<div><pre><code>$ <span class="console-input">ansible -i hosts 192.168.33.12 -m yum -s -a name=telnet</span>
<span class="console-ok">192.168.33.12 | success &gt;&gt; {
    "changed": true, 
    "msg": "warning: rpmts_HdrFromFdno: Header V3 RSA/SHA1 Signature, key ID c105b9de: NOKEY\nImporting GPG key 0xC105B9DE:\n Userid : CentOS-6 Key (CentOS 6 Official Signing Key) &lt;centos-6-key@centos.org&gt;\n Package: centos-release-6-5.el6.centos.11.1.x86_64 (@anaconda-CentOS-201311272149.x86_64/6.5)\n From   : /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6\n", 
    "rc": 0, 
    "results": [
        "Loaded plugins: fastestmirror, security\nLoading mirror speeds from cached hostfile\n * base: www.ftp.ne.jp\n * extras: www.ftp.ne.jp\n * updates: www.ftp.ne.jp\nSetting up Install Process\nResolving Dependencies\n--&lt; Running transaction check\n---&lt; Package telnet.x86_64 1:0.17-47.el6_3.1 will be installed\n--&lt; Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package         Arch            Version                    Repository     Size\n================================================================================\nInstalling:\n telnet          x86_64          1:0.17-47.el6_3.1          base           58 k\n\nTransaction Summary\n================================================================================\nInstall       1 Package(s)\n\nTotal download size: 58 k\nInstalled size: 109 k\nDownloading Packages:\nRetrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6\nRunning rpm_check_debug\nRunning Transaction Test\nTransaction Test Succeeded\nRunning Transaction\n\r  Installing : 1:telnet-0.17-47.el6_3.1.x86_64                              1/1 \n\r  Verifying  : 1:telnet-0.17-47.el6_3.1.x86_64                              1/1 \n\nInstalled:\n  telnet.x86_64 1:0.17-47.el6_3.1                                               \n\nComplete!\n"
    ]
}</span></code></pre></div>

      <p>モジュールのドキュメントが <code>ansible-doc</code> コマンドで確認できます。これ地味に便利です。バージョン 1.4 から PAGER を使って表示されるようになりました</p>

<div><pre><code>$ <span class="console-input">ansible-doc yum</span></code></pre></div>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="simple-playbook" class="anchor" href="#simple-playbook"></a>4. 簡単な Playbook を書いて試す</h1>
      </div>

      <p>それではいよいよ Playbook を書いてみましょう</p>
      <p>今度はインベントリファイルでグループを定義しておきます</p>

<div><pre><code>$ <span class="console-input">cat &lt;&lt;_EOD_ &gt; hosts</span>
[test-servers]
192.168.33.12
<span class="console-input">_EOD_</span></code></pre></div>

      <p>次に playbook ファイル (YAML) を作成します</p>

<div><pre><code>$ <span class="console-input">cat &lt;&lt;_EOD_ &gt; simple-playbook.yml</span>
---
- hosts: test-servers
  sudo: yes
  tasks:
    - name: be sure httpd is installed
      yum: name=httpd state=installed

    - name: be sure httpd is running and enabled
      service: name=httpd state=running enabled=yes
<span class="console-input">_EOD_</span></code></pre></div>

      <p>この playbook の内容は次の通り</p>

      <dl>
        <dt>hosts: test-servers</dt>
        <dd style="margin-left: 2em">対象のホストまたはグループを指定する (glob [*] も使えます)<br>
    カンマ区切りでも、YAML のリスト指定でも大丈夫です</dd>
        <dt>sudo: yes</dt>
        <dd style="margin-left: 2em">リモートホストで sudo を使って実行する<br>
デフォルトでは root としての実行ですが、別途 sudo_user を指定することで別のユーザーとして実行することも可能です</dd>
        <dt>tasks:</dt>
        <dd style="margin-left: 2em">実行する処理を定義します<br>
name は必須ではありません、<code>yum</code>, <code>service</code> がモジュール名で、それに続くのが各モジュールのオプションです</dd>
      </dl>

      <p>playbook の syntax check を行なってみます。<code>--syntax-check</code> オプションを使います</p>

<div><pre><code>$ <span class="console-input">ansible-playbook -i hosts simple-playbook.yml --syntax-check</span>

playbook: simple-playbook.yml
</code></pre></div>

      <p>次に task の一覧を確認してみましょう。<code>--list-tasks</code> オプションを使います (<a href="https://github.com/yteraoka/ansible-tutorial/wiki/ansible-playbook%20%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89">その他のオプション一覧はこちら</a>)</p>

<div><pre><code>$ <span class="console-input">ansible-playbook -i hosts simple-playbook.yml --list-tasks</span>

playbook: simple-playbook.yml

  play #1 (test-servers):
    be sure httpd is installed
    be sure httpd is running and enabled
</code></pre></div>

      <p>エラーがなければこのような出力です。エラーがあると赤字で ERROR ... と表示されます</p>

      <p>次は dry-run です、<code>--check</code> オプションを指定することで変更は行わないが、実際に実行するとこうなるという出力がされます<br>(1.2 の時はエラーになってたけど改善されてますね)</p>

<div><pre><code>$ <span class="console-input">ansible-playbook -i hosts simple-playbook.yml --check</span>

PLAY [test-servers] *********************************************************** 

GATHERING FACTS *************************************************************** 
<span class="console-ok">ok: [192.168.33.12]</span>

TASK: [be sure httpd is installed] ******************************************** 
<span class="console-changed">changed: [192.168.33.12]</span>

TASK: [be sure httpd is running and enabled] ********************************** 
<span class="console-ok">ok: [192.168.33.12]</span>

PLAY RECAP ******************************************************************** 
<span class="console-changed">192.168.33.12</span>              : <span class="console-ok">ok=3</span>    <span class="console-changed">changed=1</span>    unreachable=0    failed=0</code></pre></div>

      <p>ではいよいよ実行してみましょう</p>

<div><pre><code>$ <span class="console-input">ansible-playbook -i hosts simple-playbook.yml</span>

PLAY [test-servers] *********************************************************** 

GATHERING FACTS *************************************************************** 
<span class="console-ok">ok: [192.168.33.12]</span>

TASK: [be sure httpd is installed] ******************************************** 
<span class="console-changed">changed: [192.168.33.12]</span>

TASK: [be sure httpd is running and enabled] ********************************** 
<span class="console-changed">changed: [192.168.33.12]</span>

PLAY RECAP ******************************************************************** 
<span class="console-changed">192.168.33.12</span>              : <span class="console-ok">ok=3</span>    <span class="console-changed">changed=2</span>    unreachable=0    failed=0</code></pre></div>

      <p>うまくいきましたね</p>

      <p>node2 で実際に設定されているか確認しましょう</p>

<div><pre><code>$ <span class="console-input">sudo chkconfig --list httpd</span>
httpd          	0:off	1:off	2:on	3:on	4:on	5:on	6:off
$ <span class="console-input">sudo service httpd status</span>
httpd (pid  2896) is running...</code></pre></div>

      <p>冪等性があるため再度実行しても対象サーバーの状態は変わらない。 ただし、既に package がインストールされていたり、サービスの設定がされていたりするのでコマンドの出力は変わる。(changed が ok だったり skipping だったりする) </p>

      <p>2度目の実行の出力</p>

<div><pre><code>$ <span class="console-input">ansible-playbook -i hosts simple-playbook.yml</span>

PLAY [test-servers] *********************************************************** 

GATHERING FACTS *************************************************************** 
<span class="console-ok">ok: [192.168.33.12]</span>

TASK: [be sure httpd is installed] ******************************************** 
<span class="console-ok">ok: [192.168.33.12]</span>

TASK: [be sure httpd is running and enabled] ********************************** 
<span class="console-ok">ok: [192.168.33.12]</span>

PLAY RECAP ******************************************************************** 
<span class="console-ok">192.168.33.12</span>              : <span class="console-ok">ok=3</span>    changed=0    unreachable=0    failed=0</code></pre></div>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="gather-facts" class="anchor" href="#gather-facts"></a>5. 対象ホストの情報を取得する</h1>
      </div>

      <p>実行結果に「GATHERING FACTS」と出力されています。このような task は playbook に書いていません。これは何でしょう？名前のとおりですが、これは対象サーバーから情報を収集する処理です。次のようにして内容を確認すことができます。</p>

<div><pre style="height: 30em; overflow: scroll"><code>$ <span class="console-input">ansible -m setup -i hosts 192.168.33.12</span>
<span class="console-ok">192.168.33.12 | success >> {
    "ansible_facts": {
        "ansible_all_ipv4_addresses": [
            "10.0.2.15", 
            "192.168.33.12"
        ], 
        "ansible_all_ipv6_addresses": [
            "fe80::a00:27ff:fe4d:b37d", 
            "fe80::a00:27ff:fed5:b2ee"
        ], 
        "ansible_architecture": "x86_64", 
        "ansible_bios_date": "12/01/2006", 
        "ansible_bios_version": "VirtualBox", 
        "ansible_cmdline": {
            "KEYBOARDTYPE": "pc", 
            "KEYTABLE": "us", 
            "LANG": "en_US.UTF-8", 
            "SYSFONT": "latarcyrheb-sun16", 
            "quiet": true, 
            "rd_LVM_LV": "VolGroup/lv_root", 
            "rd_NO_DM": true, 
            "rd_NO_LUKS": true, 
            "rd_NO_MD": true, 
            "rhgb": true, 
            "ro": true, 
            "root": "/dev/mapper/VolGroup-lv_root"
        }, 
        "ansible_date_time": {
            "date": "2013-12-16", 
            "day": "16", 
            "epoch": "1387201344", 
            "hour": "13", 
            "iso8601": "2013-12-16T13:42:24Z", 
            "iso8601_micro": "2013-12-16T13:42:24.143102Z", 
            "minute": "42", 
            "month": "12", 
            "second": "24", 
            "time": "13:42:24", 
            "tz": "UTC", 
            "tz_offset": "+0000", 
            "year": "2013"
        }, 
        "ansible_default_ipv4": {
            "address": "10.0.2.15", 
            "alias": "eth0", 
            "gateway": "10.0.2.2", 
            "interface": "eth0", 
            "macaddress": "08:00:27:4d:b3:7d", 
            "mtu": 1500, 
            "netmask": "255.255.255.0", 
            "network": "10.0.2.0", 
            "type": "ether"
        }, 
        "ansible_default_ipv6": {}, 
        "ansible_devices": {
            "sda": {
                "holders": [], 
                "host": "IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)", 
                "model": "VBOX HARDDISK", 
                "partitions": {
                    "sda1": {
                        "sectors": "1024000", 
                        "sectorsize": 512, 
                        "size": "500.00 MB", 
                        "start": "2048"
                    }, 
                    "sda2": {
                        "sectors": "82860032", 
                        "sectorsize": 512, 
                        "size": "39.51 GB", 
                        "start": "1026048"
                    }
                }, 
                "removable": "0", 
                "rotational": "1", 
                "scheduler_mode": "cfq", 
                "sectors": "83886080", 
                "sectorsize": "512", 
                "size": "40.00 GB", 
                "support_discard": "0", 
                "vendor": "ATA"
            }, 
            "sr0": {
                "holders": [], 
                "host": "IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)", 
                "model": "CD-ROM", 
                "partitions": {}, 
                "removable": "1", 
                "rotational": "1", 
                "scheduler_mode": "cfq", 
                "sectors": "2097151", 
                "sectorsize": "512", 
                "size": "1024.00 MB", 
                "support_discard": "0", 
                "vendor": "VBOX"
            }
        }, 
        "ansible_distribution": "CentOS", 
        "ansible_distribution_release": "Final", 
        "ansible_distribution_version": "6.5", 
        "ansible_domain": "localdomain", 
        "ansible_env": {
            "CVS_RSH": "ssh", 
            "G_BROKEN_FILENAMES": "1", 
            "HOME": "/home/vagrant", 
            "LANG": "C", 
            "LESSOPEN": "|/usr/bin/lesspipe.sh %s", 
            "LOGNAME": "vagrant", 
            "MAIL": "/var/mail/vagrant", 
            "PATH": "/usr/local/bin:/bin:/usr/bin", 
            "PWD": "/home/vagrant", 
            "SELINUX_LEVEL_REQUESTED": "", 
            "SELINUX_ROLE_REQUESTED": "", 
            "SELINUX_USE_CURRENT_RANGE": "", 
            "SHELL": "/bin/bash", 
            "SHLVL": "2", 
            "SSH_CLIENT": "192.168.33.11 58880 22", 
            "SSH_CONNECTION": "192.168.33.11 58880 192.168.33.12 22", 
            "USER": "vagrant", 
            "_": "/usr/bin/python"
        }, 
        "ansible_eth0": {
            "active": true, 
            "device": "eth0", 
            "ipv4": {
                "address": "10.0.2.15", 
                "netmask": "255.255.255.0", 
                "network": "10.0.2.0"
            }, 
            "ipv4_secondaries": [], 
            "ipv6": [
                {
                    "address": "fe80::a00:27ff:fe4d:b37d", 
                    "prefix": "64", 
                    "scope": "link"
                }
            ], 
            "macaddress": "08:00:27:4d:b3:7d", 
            "module": "e1000", 
            "mtu": 1500, 
            "promisc": false, 
            "type": "ether"
        }, 
        "ansible_eth1": {
            "active": true, 
            "device": "eth1", 
            "ipv4": {
                "address": "192.168.33.12", 
                "netmask": "255.255.255.0", 
                "network": "192.168.33.0"
            }, 
            "ipv4_secondaries": [], 
            "ipv6": [
                {
                    "address": "fe80::a00:27ff:fed5:b2ee", 
                    "prefix": "64", 
                    "scope": "link"
                }
            ], 
            "macaddress": "08:00:27:d5:b2:ee", 
            "module": "e1000", 
            "mtu": 1500, 
            "promisc": false, 
            "type": "ether"
        }, 
        "ansible_form_factor": "Other", 
        "ansible_fqdn": "localhost.localdomain", 
        "ansible_hostname": "localhost", 
        "ansible_interfaces": [
            "lo", 
            "eth1", 
            "eth0"
        ], 
        "ansible_kernel": "2.6.32-431.el6.x86_64", 
        "ansible_lo": {
            "active": true, 
            "device": "lo", 
            "ipv4": {
                "address": "127.0.0.1", 
                "netmask": "255.0.0.0", 
                "network": "127.0.0.0"
            }, 
            "ipv4_secondaries": [], 
            "ipv6": [
                {
                    "address": "::1", 
                    "prefix": "128", 
                    "scope": "host"
                }
            ], 
            "mtu": 16436, 
            "promisc": false, 
            "type": "loopback"
        }, 
        "ansible_machine": "x86_64", 
        "ansible_memfree_mb": 169, 
        "ansible_memtotal_mb": 458, 
        "ansible_mounts": [
            {
                "device": "/dev/mapper/VolGroup-lv_root", 
                "fstype": "ext4", 
                "mount": "/", 
                "options": "rw", 
                "size_available": 37423112192, 
                "size_total": 40797364224
            }, 
            {
                "device": "/dev/sda1", 
                "fstype": "ext4", 
                "mount": "/boot", 
                "options": "rw", 
                "size_available": 446151680, 
                "size_total": 507744256
            }, 
            {
                "device": "/vagrant", 
                "fstype": "vboxsf", 
                "mount": "/vagrant", 
                "options": "uid=900,gid=999,rw", 
                "size_available": 22555742208, 
                "size_total": 117461032960
            }
        ], 
        "ansible_os_family": "RedHat", 
        "ansible_pkg_mgr": "yum", 
        "ansible_processor": [
            "Intel(R) Core(TM) i3-3217U CPU @ 1.80GHz"
        ], 
        "ansible_processor_cores": 1, 
        "ansible_processor_count": 1, 
        "ansible_processor_threads_per_core": 1, 
        "ansible_processor_vcpus": 1, 
        "ansible_product_name": "VirtualBox", 
        "ansible_product_serial": "NA", 
        "ansible_product_uuid": "NA", 
        "ansible_product_version": "1.2", 
        "ansible_python_version": "2.6.6", 
        "ansible_selinux": false, 
        "ansible_ssh_host_key_dsa_public": "AAAAB3NzaC1kc3MAAACBAOQ2z5AKK04+mx8RJoSB8axADs5md7igiVmva7EhmibLkB35vpKVICI78y6l9jt6yq16+PFsEfOCEVXifXblfz122vu+pIeccEan52q5vn+W4xfu7svNDoKKg6VXgAezMCHWk15u9rQ2S5PY49VSut/SaVa2bYarNOpjY88hQv/NAAAAFQDjFghslSnBJfqJiRDgkVW7gR9P/QAAAIBXo7OpZh7kBgqHIbHFY2gSbtr6UUa/n5BmHBAbuJQpcv6EgeW0LJkE/6JjFgqJLMEjgd6JKdotz6p8397S7xXzwJBn/EONWR4g9NSwIgjcK4/6UALpkxcz73lSXhYXvGIMC+GYlZOTNm1ieuy1Oi/K0S4DBJhLNtlXE4Pm32gDCQAAAIB7C97Tt5DPEDl5IekSuZDfV9D33uj5BCZivINM40JxdVzG79RQyUAstiVvRWmvai02C0ff9T2VLbihHidHeaA/cTmAIXOlEda/vE/qrmmCVoalUOmEyOLDR6UXE/OKriKLtlpHzos5RJrfPc9xpme4DBdwuiXkwMyi/lY6164jfA==", 
        "ansible_ssh_host_key_rsa_public": "AAAAB3NzaC1yc2EAAAABIwAAAQEA1MfoV6b96gaG82/Iee8abtYEpyGEuaMKovWBoIKyEiDH4A/iiICRHtyhc/IYFQixM6GQI/j1kuVC4moDUCVMXqqwI1aJcKroNexVsRnoKToLXW/NGZ90bpd7m+YVd+LomaXUAFWq64j3Eo3+hXkf4k8iSQrz06jCLcfllDuf8JuRto1wIi7GJCqxCjgEEelmhCSvwrLbuFM2FD4i34tWj7+PraPNm/kkCqooev0mKPArXSZ65WCsIuZ2VV4F0FQnU6iOqYwphEsiWPvaQZfEwzzD3Tr4RkWDPu7i4VQN++KmzsPIjYp514KMydJy7/3Msqee3xtexkv/l0lRyihpRQ==", 
        "ansible_swapfree_mb": 927, 
        "ansible_swaptotal_mb": 927, 
        "ansible_system": "Linux", 
        "ansible_system_vendor": "innotek GmbH", 
        "ansible_user_id": "vagrant", 
        "ansible_userspace_architecture": "x86_64", 
        "ansible_userspace_bits": "64", 
        "ansible_virtualization_role": "guest", 
        "ansible_virtualization_type": "virtualbox"
    }, 
    "changed": false
}</span>
</code></pre></div>

      <p>このようにして収集したデータを task のオプションやテンプレートの変数に使うことができます</p>

      <p>
      <ul>
        <li>IP Address は <code>{{ ansible_eth0["ipv4"]["address"] }}</code> のようにして使えます。 <code>{{ ansible_eth0.ipv4.address }}</code> でもいけますね<br><br>
<div><pre><code>tasks:
  - name: gathering data task example
    command: echo {{ ansible_eth0.ipv4.address }}</code></pre></div>
        </li>
        <li><code>{{ ansible_processor_count * 5 }}</code> と計算結果を使うこともできます。CPU のコア数を元にプロセス数を設定したりする場合に使えます
        </li>
        <li>次のようにして task 実行の条件判定にも使えます<br><br>
<div><pre><code>tasks:
  - name: "shutdown Debian flavored systems"
    command: /sbin/shutdown -t now
    when: ansible_os_family == "Debian"</code></pre></div>
        </li>
      </ul>

      <p>そして、これらのデータが不要な場合は <code>gather_facts: no</code> とすることで収集しないことで playbook の実行時間を短縮できます
<div><pre><code>- hosts: all
  sudo: yes
  gather_facts: no
  roles:
    - common</code></pre></div>
      </p>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="best-practices" class="anchor" href="#best-practices"></a>6. Best Practices に沿った構成を真似る</h1>
      </div>

      <p><a href="http://docs.ansible.com/playbooks_best_practices.html">Best Practices</a> のディレクトリ構成にならって WordPress サーバーを構築する Playbook を作成します。 ここは長くなりそうだから詳細は別ページにしよう
      </p>

      <p>こんなディレクトリ構成で進めます。<a href="https://github.com/yteraoka/ansible-tutorial/tree/playbook">playbook branch</a> のファイルで一応動作すると思います。随時改善していきます。 このファイルは GitHub <a href="https://github.com/yteraoka/ansible-tutorial.git">https://github.com/yteraoka/ansible-tutorial.git</a> にあります
      </p>

<div><pre><code>$ <span class="console-input">git clone https://github.com/yteraoka/ansible-tutorial.git</span>
$ <span class="console-input">cd ansible-tutorial</span>
$ <span class="console-input">git checkout playbook</span></code></pre></div>

<div><pre><code>$ <span class="console-input">tree -F</span>
.
|-- common.yml
|-- group_vars/
|-- host_vars/
|-- roles/
|   |-- common/
|   |   |-- defaults/
|   |   |-- files/
|   |   |-- handlers/
|   |   |   `-- main.yml
|   |   |-- meta/
|   |   |-- tasks/
|   |   |   |-- common-packages.yml
|   |   |   |-- epel.yml
|   |   |   |-- main.yml
|   |   |   |-- ntp.yml
|   |   |   `-- sshd.yml
|   |   |-- templates/
|   |   `-- vars/
|   `-- wordpress/
|       |-- defaults/
|       |-- files/
|       |-- handlers/
|       |   `-- main.yml
|       |-- meta/
|       |-- tasks/
|       |   |-- httpd.yml
|       |   |-- main.yml
|       |   |-- mysql.yml
|       |   |-- php.yml
|       |   `-- wordpress.yml
|       |-- templates/
|       |   |-- httpd.conf.j2
|       |   `-- wp-config.php.j2
|       `-- vars/
|           `-- main.yml
|-- site.yml
|-- test-servers
`-- wordpress.yml

19 directories, 19 files
</code></pre></div>

      <p>タスクの一覧を確認するには次のように <code>--list-tasks</code> オプションをつけて <code>ansible-playboook</code> コマンドを実行します
      </p>

<div><pre><code>$ <span class="console-input">ansible-playbook --list-tasks -i test-servers site.yml</span>

playbook: site.yml

  play #1 (all):
    be sure epel repository is installed
    disable epel repository
    be sure common packages are installed
    configure sshd_config
    be sure ntpd is running and enabled

Please enter MySQL wordpress user password [wordpress]: 
  play #2 (wordpress):
    be sure httpd is installed
    create document root
    be sure httpd is configured
    remove httpd welcome.conf
    be sure httpd is running and enabled
    be sure mysql-server is installed
    be sure mysqld is running and enabled
    Create database
    Create database user
    be sure php is installed
    set timezone in php.ini
    download wordpress package
    unzip wordpress zip file
    generate secret keys
    read secret keys
    configure wp-config.php
</code></pre></div>

      <p>MySQL ユーザーのパスワードは playbook に書かず、実行時に入力するようにしてあるため、<code>Please enter MySQL wordpress user password:</code> と、プロンプトが表示されます。ブランクで Enter を押すと playbook に書いてあるデフォルトのパスワードが使われます
      </p>

      <p>実際の実行は次のコマンドですが</p>

<div><pre><code>$ <span class="console-input">ansible-playbook -i test-servers site.yml</span></code></pre></div>

      <p>実行前に各ディレクトリ、ファイルの役割を確認しましょう</p>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="best-practices-directory" class="anchor" href="#best-practices-directory"></a>6.1. 各ディレクトリ、ファイルの役割・意味</h1>
      </div>

      <p>数種類のサービスが Web - App - DB 構成(それぞれは Role)で構築されており、それぞれに2ヶ所のロケーションにあるとする(Multi-AZみたいな)</p>

      <dl>
        <dt>group_vars/</dt>
        <dd style="margin-left: 2em">グループ毎の変数を定義するのに使います、role ではありません、role 毎の変数は roles/{role_name}/vars/ を使います。例えばロケーション毎に異なる変数など。ファイル名はインベントリファイルで設定するグループ名です。インベントリファイルにグループ変数を書くことも可能です</dd>
        <dt>host_vars/</dt>
        <dd style="margin-left: 2em">ホスト毎の変数を定義するのに使います。group_vars と同じくファイル名はインベントリファイルに設定したホスト名です。インベントリファイルの中でホスト名の右に並べて書くこともできます</dd>
        <dt>roles/</dt>
        <dd style="margin-left: 2em">このディレクトリの下に role (役割) 毎のディレクトリを作成し、それぞれの role にさらに <code>files/</code>, <code>handlers/</code>, <code>tasks/</code>, <code>templates/</code>, <code>vars/</code>, <code>defaults/</code>, <code>meta/</code> というサブディレクトリを作成します (その role で使うもののみ)</dd>
        <dt>roles/*/files/</dt>
        <dd style="margin-left: 2em">当該 role の task で使うファイル関連モジュール (<a href="http://docs.ansible.com/copy_module.html">copy</a>) が src として使うファイルの置き場所。任意のファイル名で置きます</dd>
        <dt>roles/*/handlers/</dt>
        <dd style="margin-left: 2em">設定変更後にサービスの再起動をさせたりする場合に、notify という定義で処理を呼び出しますが、その呼び出されるハンドラをここで定義します。main.yml というファイルで作成しますが、<code>include</code> という定義で複数ファイルをそこから読み込ませることが可能です</dd>
        <dt>roles/*/tasks/</dt>
        <dd style="margin-left: 2em">何かをインストールしたり、ユーザーを作成したりする task 定義のファイルをここに置きます。handlers と同じように main.yml というファイルが起点となります</dd>
        <dt>roles/*/templates/</dt>
        <dd style="margin-left: 2em"><a href="http://docs.ansible.com/template_module.html">template</a> モジュールで利用するテンプレートファイルを置きます。このモジュールでは <a href="http://jinja.pocoo.org/docs/">Jinja2</a> (神社) というテンプレートエンジンが使われていて .j2 という拡張子を使います</dd>
        <dt>roles/*/vars/</dt>
        <dd style="margin-left: 2em">role 毎に設定する変数を定義するファイルを置きます。handlers や tasks と同じく main.yml ファイルが起点となります</dd>
        <dt>roles/*/defaults/</dt>
        <dd style="margin-left: 2em">当該 role で使う変数の default 値を設定します。他で設定されていなければここで設定した値が使われます。main.yml に書きます。この変数が一番低い優先度です 「<a href="http://blog.1q77.com/2013/10/ansible-precedence-rules/">Ansible の変数の優先順</a>」</dd>
        <dt>roles/*/meta/</dt>
        <dd style="margin-left: 2em">role の依存設定を書きます。A という role が B という role に依存しているなら <code>roles/A/meta/main.yml</code> に次のように書きます<pre><code>---
dependencies:
  - role: B
    foo: "bar"</code></pre></dd>
        <dt>site.yml</dt>
        <dd style="margin-left: 2em"><code>ansible-playbook</code> コマンドに渡す大元 (root) の playbook ファイルです</dd>
        <dt>test-servers</dt>
        <dd style="margin-left: 2em">今回のインベントリファイルです。実際の運用では development, stage, production などというそれぞれの環境毎のファイルにするのが Best Practice っぽいです</dd>
        <dt>wordpress.yml</dt>
        <dd style="margin-left: 2em">role 毎の対象グループ、対象ホストなどを定義します。今回は wordpress サーバーをセットアップする wordpress role とするため、このファイル名としてあります。site.yml で include されています</dd>
      </dl>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="list-variable" class="anchor" href="#list-variable"></a>6.2. リスト変数を使った処理</h1>
      </div>

      <p><code>roles/common/tasks/common-packages.yml</code> を見てみましょう</p>

<div><pre><code>- name: be sure common packages are installed
  yum: name={{ item }} state=installed
  with_items:
    - ntp
    - bind-utils
    - unzip
  tags: common-packages</code></pre></div>

      <p><code>with_items</code> にインストールされているべきパッケージ名を並べ、それぞれを <a href="https://github.com/yteraoka/ansible-tutorial/wiki/module-yum">yum モジュール</a>で処理します。 <code>tags</code> を指定しておくと ansible-playbook の <code>--tags / -t</code> オプションを使うことで指定の tag のついた task だけを実行可能。複数の task に同じ tag を付けられます
      </p>

      <p><code>roles/common/tasks/sshd.yml</code> でも sshd_config の複数行の編集をまとめるために <code>with_items</code> を使っています
      </p>

<div><pre><code>- name: configure sshd_config
  lineinfile: &gt;
    dest=/etc/ssh/sshd_config
    owner=root group=root mode=0600 backup=yes
    regexp="{{ item.regexp }}"
    line="{{ item.line }}"
    insertafter="{{ item.insertafter }}"
  with_items:
    - regexp: '^PasswordAuthentication'
      line: 'PasswordAuthentication no'
      insertafter: '#PasswordAuthentication'
    - regexp: '^PermitRootLogin'
      line: 'PermitRootLogin no'
      insertafter: '#PermitRootLogin'
    - regexp: '^GSSAPIAuthentication'
      line: 'GSSAPIAuthentication no'
      insertafter: '#GSSAPIAuthentication'
  notify: restart sshd
  tags: sshd</code></pre></div>

      <p>それぞれ別の task にしてしまうと <code>notify</code> によって3度も sshd の restart が必要になってしまう...と思ったら、別々にしても <code>notify</code> は一度しか処理されませんでした。<code>notify</code> はその role の最後に実行されるようです。よって、こういう場合はわかりやすい書き方を選ぶのが良いでしょう。ただし、task が増えるとその分 SSH の回数が増えます。</p>

      <p><code>lineinfile</code> モジュールは設定ファイルの置換に便利です。<code>insertafter</code> や <code>backref</code> オプションは要チェックです</p>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="mysql" class="anchor" href="#mysql"></a>6.3. MySQL 関連</h1>
      </div>

      <p>パッケージのインストールだけでなく、DBの作成、ユーザーの作成も行えます </p> 

<div><pre><code>---
# yum で mysql-server と mysql_* モジュールで必要な MySQL-python パッケージをインストール
- name: be sure mysql-server is installed
  yum: name={{ item }} state=installed
  with_items:
    - mysql-server
    - MySQL-python
  tags: mysqld

# mysqld の起動、自動起動設定
- name: be sure mysqld is running and enabled
  service: name=mysqld state=running enabled=yes
  tags: mysqld

# wordpress 用 DB の作成
- name: Create database
  mysql_db: db={{ dbname }} state=present encoding=utf8
  tags: mysqld

# wordpress 用 DB ユーザーの作成
- name: Create database user
  mysql_user: &gt;
    name={{ dbuser }}
    password="{{ dbpassword }}"
    priv={{ dbname }}.*:ALL
    state=present
  tags: mysqld
</code></pre></div>

      <p><code>dbname</code>, <code>dbuser</code> 変数は <code>roles/wordpress/vars/main.yml</code> に書いてあり、<code>dbpassword</code> は <code>wordpress.yml</code> にて次のように <code>vars_prompt</code> 設定し、ansible-playbook 実行時に入力させています</p>

<div><pre><code>- hosts: wordpress
  sudo: yes
  roles:
    - wordpress
  vars_prompt:
    - name: "dbpassword"
      prompt: "Please enter MySQL wordpress user password"
      default: "wordpress"
</code></pre></div>

      <p>それでは playbook を実際に実行してみましょう</p>

<div><pre><code>$ <span class="console-input">ansible-playbook -i test-servers site.yml</span>
</code></pre></div>

      <p>うまくいったでしょうか？</p>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="test-with-serverspec" class="anchor" href="#test-with-serverspec"></a>7. serverspec でテストする</h1>
      </div>

      <p>今実行した playbook がうまく動作したことを確認するために <a href="http://serverspec.org/">ServerSpec</a> を利用してチェックするようにしてみましょう</p> 



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="install-ruby" class="anchor" href="#install-ruby"></a>7.1. Ruby のインストール</h1>
      </div>

      <p>ServerSpec は Ruby 製ですので、まずは Ruby のインストールですが、 CentOS 6 はいまだに 1.8.7 と古いので最新のバージョンを ruby-build を使って /opt/ruby-2.0.0 にインストールします</p> 

      <p>Ruby のコンパイルに必要なものをインストール</p> 

<div><pre><code>$ <span class="console-input">sudo rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
$ <span class="console-input">sudo yum -y install git gcc gcc-c++ make patch readline-devel zlib-devel libyaml-devel openssl-devel</span>
</code></pre></div>

      <p>ruby-build を git clone する</p> 

<div><pre><code>$ <span class="console-input">git clone https://github.com/sstephenson/ruby-build.git</span>
</code></pre></div>

      <p>最新の Ruby (2.0.0-p353) をインストール</p> 

<div><pre><code>$ <span class="console-input">cd ruby-build</span>
$ <span class="console-input">sudo bin/ruby-build 2.0.0-p353 /opt/ruby-2.0.0</span>
</code></pre></div>

      <p>Ruby や Perl のコンパイルには結構時間がかかりますねぇ。お茶でも飲んで待ちましょう</p> 



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="install-serverspec" class="anchor" href="#install-serverspec"></a>7.2. ServerSpec のインストール</h1>
      </div>

      <p>Ruby のインストールが終わったら ServerSpec を gem でインストールします</p> 

<div><pre><code>$ <span class="console-input">sudo /opt/ruby-2.0.0/bin/gem install serverspec --no-ri --no-rdoc</span>
</code></pre></div>

      <p>あ、bundler 使ったほうが良かったかな？</p> 



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="execute-serverspec" class="anchor" href="#execute-serverspec"></a>7.3. ServerSpec を実行してみる</h1>
      </div>

      <p>まずは <code>serverspec-init</code> コマンドで土台を作ります</p> 

<div><pre><code>$ <span class="console-input">mkdir ~/serverspec</span>
$ <span class="console-input">cd ~/serverspec</span>
$ <span class="console-input">/opt/ruby-2.0.0/bin/serverspec-init</span>
Select OS type:

  1) UN*X
  2) Windows

Select number: <span class="console-input">1</span>

Select a backend type:

  1) SSH
  2) Exec (local)

Select number: <span class="console-input">1</span>

Vagrant instance y/n: <span class="console-input">n</span>
Input target host name: <span class="console-input">192.168.33.12</span>
 + spec/
 + spec/192.168.33.12/
 + spec/192.168.33.12/httpd_spec.rb
 + spec/spec_helper.rb
 + Rakefile
</code></pre></div>

      <p>Vagrant 使ってるけど、Vagrant の Guest 同士での SSH だから Vagrant じゃないよと</p>

      <p>今回の設定では httpd.conf の ServerName は localhost となっているのでテストをちょっといじる</p>

<div><pre><code>$ <span class="console-input">sed -i 's/192.168.33.12/localhost/' spec/192.168.33.12/httpd_spec.rb</span>
</code></pre></div>

      <p>それでは rake コマンドでテストを実行してみましょう。今回インストールした ruby のパスが PATH に入ってないので先に入れておく必要があります</p>

<div><pre><code>$ <span class="console-input">PATH=/opt/ruby-2.0.0/bin:$PATH</span>
$ <span class="console-input">rake spec</span>
/opt/ruby-2.0.0/bin/ruby -S rspec spec/192.168.33.12/httpd_spec.rb
......

Finished in 0.99275 seconds
6 examples, 0 failures
</code></pre></div>

      <p>成功しました</p>

      <p><code>spec/192.168.33.12/httpd_spec.rb</code> に書いてあるテストが実行されました。<br>
内容は次の通り
<ul>
  <li>httpd パッケージがインストールされていること</li>
  <li>httpd サービスが有効になっていること (chkconfig httpd on 状態)</li>
  <li>httpd が起動していること</li>
  <li>ポート 80 が LISTEN 状態となっていること</li>
  <li><code>/etc/httpd/conf/httpd.conf</code> ファイルが存在すること</li>
  <li>httpd.conf に "ServerName localhost" が含まれること</li>
</ul>
      </p>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="test-mysqld" class="anchor" href="#test-mysqld"></a>7.4. mysqld のテストを作成</h1>
      </div>

      <p><code>httpd_spec.rb</code> を参考に mysqld のテストを作成しましょう。
これは JTF <del>のパクリですね</del> とまったく同じ課題です。
<ul>
  <li>mysql-server パッケージがインストールされていること</li>
  <li>mysqld デーモンが有効化されていること (chkconfig mysqld on されていること)</li>
  <li>mysqld デーモンが起動していること</li>
  <li>3306 ポートが LISTEN していること</li>
</ul>
      </p>

<div><pre><code>$ <span class="console-input">vi spec/192.168.33.12/mysqld_spec.rb</span></code></pre></div>

      <p>(例はこちら: <a href="https://gist.github.com/yteraoka/6156753">https://gist.github.com/yteraoka/6156753</a>)</p>

      <p>作成したら再度 rake spec コマンドを実行します</p>

<div><pre><code>$ <span class="console-input">rake spec</span>
/opt/ruby-2.0.0/bin/ruby -S rspec spec/192.168.33.12/httpd_spec.rb spec/192.168.33.12/mysqld_spec.rb
..........

Finished in 1.24 seconds
10 examples, 0 failures
</code></pre></div>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="test-wordpress" class="anchor" href="#test-wordpress"></a>7.5. WordPress のテストを作成</h1>
      </div>

      <p>Chef 版との違いが出ました。WordPress が日本語版だったので出力されるHTMLが日本語です。。。<br>
http://localhost/wp-admin/install.php にアクセスすると出力されるメッセージ(HTML)に「<strong>5分でできる WordPress の有名なインストールプロセスへようこそ</strong>」が含まれることをチェックしましょう
      </p>

<div><pre><code>$ <span class="console-input">vi spec/192.168.33.12/wordpress_spec.rb</span></code></pre></div>

      <p>(例はこちら: <a href="https://gist.github.com/yteraoka/6186278">https://gist.github.com/yteraoka/6186278</a>)</p>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="more" class="anchor" href="#more"></a>8. もっと知る</h1>
      </div>

      <p><a href="https://github.com/yteraoka/ansible-tutorial/wiki/Ansible-Note">Ansible Note</a> にモジュールや細かいことを書いていきます。(Ansible in detail はなかなか更新できないので Wiki に移しました)
      </p>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="more2" class="anchor" href="#more2"></a>8.1. 2013/9/9 追記</h1>
      </div>

      <p>この tutorial では <code>role</code> として <code>common</code>, <code>wordpress</code> という分け方をしましたが、その後、<a href="http://www.ansibleworks.com/ansibleworks-awx/">Ansible AWX</a> のインストーラーなどを見ると <code>nginx</code>, <code>mysql</code> などを <code>role</code> にするのが良さそうです。その上で site.yml を次のようにするのが良いようです</p>

<div><pre><code>---
- hosts: all
  sudo: yes
  roles:
    - { role: sshd }
    - { role: ntpd }
    - { role: epel }

- hosts: webservers
  sudo: yes
  roles:
    - { role: nginx, name: 'value' }
    - ...

- hosts: dbservers
  sudo: yes
  roles:
    - { role: mysql, name: 'value' }
    - ...
</code></pre></div>

      <p>「role A は role B に依存しているよ」なんていう書き方もできるようです。
<a href="http://qiita.com/hnakamur/items/63f2d94badf89246e04a">Ansibleのroleを使いこなす</a> [Qiita]</p>



<!-- ********************************************************************** -->



      <div class="page-header">
        <h1><a name="more3" class="anchor" href="#more3"></a>8.2. 2014/1/31 追記
</h1>
      </div>

      <p>ここで紹介したベストプラクティス構成で多種多様なサーバーを一つにまとめるのは非常に困難です。共有したい role だけを外だしにするのが筆者の今のお勧めです。「<a href="http://qiita.com/yteraoka/items/5ed2bddefff32e1b9faf">Ansible オレ>オレベストプラクティス - Qiita [キータ]</a>」お試しあれ。</p>



<!-- ********************************************************************** -->



    </div> <!-- /container -->



<!-- ********************************************************************** -->



    <footer class="bs-footer" role="contentinfo">
      <div class="container">
        <div class="bs-social">
          <ul class="bs-social-buttons">
            <li>
              <iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=yteraoka&amp;repo=ansible-tutorial&amp;type=watch&amp;count=true" width="100" height="20" title="Star on GitHub"></iframe>
            </li>
            <li class="follow-btn">
              <a href="https://twitter.com/yteraoka" class="twitter-follow-button" data-link-color="#0069D6" data-show-count="true">Follow @yteraoka</a>
            </li>
            <li class="tweet-btn">
              <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://yteraoka.github.io/ansible-tutorial/" data-count="horizontal" data-via="twbootstrap" data-related="Ansible Tutorial">Tweet</a>
            </li>
          </ul>
        </div>
      </div>
    </footer>



<!-- ********************************************************************** -->



    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>


<!-- ********************************************************************** -->


  </body>
</html>
